---
import { ExternalLink } from "@lucide/astro"

interface Props {
  id?: string;
  title?: string;
  description?: string;
  image_url?: string;
  url?: string;
  likes_count?: number;
  small?: boolean;
  is_promoted?: boolean;
  is_featured?: boolean;
  isButton?: boolean;
}

const {
  id,
  title,
  description,
  image_url,
  url,
  likes_count,
  small,
  is_promoted,
  is_featured,
  isButton = false,
} = Astro.props;
---

<script is:client>
  const STORAGE_KEY = "oksaas";

  const LIKE_CLASSES = [
    "bg-kiwi-600/20",
    "border-kiwi-600",
    "shadow-lg",
    "shadow-kiwi-600/20",
  ];

  function getLikes() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  }

  function saveLikes(arr) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }

  function isLiked(id) {
    return getLikes().includes(id);
  }

  function toggleLike(id) {
    let likes = getLikes();

    if (likes.includes(id)) {
      likes = likes.filter((x) => x !== id);
    } else {
      likes.push(id);
    }

    saveLikes(likes);
    updateLikeButton(id);
  }

  function updateLikeButton(id) {
    const btn = document.querySelector(`[data-like="${id}"]`);
    if (!btn) return;

    const liked = isLiked(id);

    // Button state (color)
    if (liked) btn.classList.add(...LIKE_CLASSES);
    else btn.classList.remove(...LIKE_CLASSES);

    // SVG toggle
    const arrow = btn.querySelector(".arrow-wrapper");
    const heart = btn.querySelector(".heart-wrapper");

    if (liked) {
      arrow.classList.add("hidden");
      heart.classList.remove("hidden");
    } else {
      arrow.classList.remove("hidden");
      heart.classList.add("hidden");
    }

    // Update displayed like count
    const countEl = btn.querySelector(".like-count");
    const baseCount = parseInt(btn.dataset.count);
    countEl.textContent = liked ? baseCount + 1 : baseCount;
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("[data-like]").forEach((btn) => {
      updateLikeButton(btn.dataset.like);
    });
  });
</script>

<div class={`flex items-center gap-12 justify-between w-full py-2 cursor-pointer px-2 ${is_featured ? 'bg-kiwi-600/20' : is_promoted? 'bg-neutral-200 dark:bg-neutral-800' : ''}`}>
  <a
    href={`${url}?utm_source=oksaas`}
    rel="dofollow"
    target="blank"
    class="grow flex items-center gap-4 hover:opacity-90 transition"
  >
    <div
      class={`
       ${small ? "size-10 min-w-10 min-h-10" : "size-12 min-w-12 min-h-12"} flex items-center justify-center`}
    >
      {
        image_url && (
          <img
            src={image_url}
            alt={title}
            class="w-full h-full object-cover"
            loading="lazy"
          />
        )
      }
    </div>

    <div class="grid grow">
      <h3 class="font-[600] text-black dark:text-neutral-200 leading-tight">
        {title}
      </h3>
      <p class="text-neutral-500 text-sm line-clamp-2 text-nowrap truncate">
        {
          description && description.length > 60
            ? description.slice(0, 60) + "..."
            : description
        }
      </p>
    </div>
    {!isButton && <div class="flex items-center justify-center gap-2"> 
      {is_featured && <div class="text-xs text-kiwi-600 font-[600] bg-transparent border border-kiwi-600 px-1 py-[1px]">Featured</div>}
      {is_promoted && <div class="text-xs text-amber-600 font-[600] bg-transparent border border-amber-600 px-1 py-[1px]">Promoted</div>}
      <ExternalLink class={`${is_featured ? 'text-kiwi-700' : is_promoted ? 'text-amber-600' : 'text-neutral-400 dark:text-neutral-200 '}`} />
    </div>}
  </a>


  {isButton && <button
    data-like={id}
    data-count={likes_count}
    class="group relative font-[600] min-w-[32px] min-h-[32px] max-w-[32px] max-h-[32px] cursor-pointer grid duration-300"
    type="button"
    onclick={`toggleLike('${id}')`}
  >
    <div class="flex items-center justify-center min-h-[32px] -top-1">
      <!-- ARROW → shown only when NOT liked -->
      <div class="arrow-wrapper">
        <!-- Normal arrow -->
        <div class="arrow-default flex group-hover:hidden">
          <svg
            class="mx-auto"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path fill="currentColor" d="m7 14l5-5l5 5z"></path>
          </svg>
        </div>

        <!-- Hover arrow (animated) -->
        <div class="arrow-hover hidden group-hover:flex float-up-fade">
          <svg
            class="mx-auto"
            xmlns="http://www.w3.org/2000/svg"
            width="32"
            height="32"
            viewBox="0 0 24 24"
          >
            <path fill="currentColor" d="m7 14l5-5l5 5z"></path>
          </svg>
        </div>
      </div>

      <!-- HEART → shown only when liked -->
      <div class="heart-wrapper hidden">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            d="M9 2H5v2H3v2H1v6h2v2h2v2h2v2h2v2h2v2h2v-2h2v-2h2v-2h2v-2h2v-2h2V6h-2V4h-2V2h-4v2h-2v2h-2V4H9zm0 2v2h2v2h2V6h2V4h4v2h2v6h-2v2h-2v2h-2v2h-2v2h-2v-2H9v-2H7v-2H5v-2H3V6h2V4z"
          ></path>
        </svg>
      </div>
    </div>
    <div class="relative block text-[13px] like-count max-h-[32px] -top-1">
      {likes_count}
    </div>
  </button>}
</div>
